{% extends "bodega/base.html" %}
{% block title %}{% if object %}Editar Empleado{% else %}Nuevo Empleado{% endif %} - Bodega Eirete{% endblock %}
{% load tz %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="mb-3 d-flex justify-content-between align-items-center">
          <span>{% if object %}Editar Empleado{% else %}Nuevo Empleado{% endif %}</span>
          {% if object %}<span class="small text-muted">Alta: {{ object.fecha_alta|localtime|date:"d/m/Y H:i" }}</span>{% endif %}
        </h4>

        <form method="post" novalidate>
          {% csrf_token %}
          {{ form.persona_id }}
          {{ form.non_field_errors }}

          {% if not object %}
          <div class="mb-2 position-relative" id="persona-search-wrap">
            <label class="form-label small text-muted">Buscar Persona</label>
            <div class="input-group">
              <input id="persona-q" type="text" class="form-control" placeholder="Cédula o Nombre...">
              <button class="btn btn-outline-secondary" type="button" id="btn-persona-buscar">
                <i class="bi bi-search"></i> Buscar
              </button>
            </div>
            <div id="persona-results" class="dropdown-menu w-100"></div>
            <div class="form-text">Seleccioná una persona para autocompletar, o seguí completando manualmente.</div>
          </div>
          {% else %}
          <div class="mb-2">
            <span class="badge bg-light text-dark border">Alta: {{ object.fecha_alta|localtime|date:"d/m/Y H:i" }}</span>
          </div>
          {% endif %}

          <div class="row g-2 row-cols-1 row-cols-md-2 row-cols-lg-4">
            <div class="col">
              <label class="form-label" for="{{ form.cedula.id_for_label }}">{{ form.cedula.label }}</label>
              {{ form.cedula }} {{ form.cedula.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}</label>
              {{ form.nombre }} {{ form.nombre.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.apellido.id_for_label }}">{{ form.apellido.label }}</label>
              {{ form.apellido }} {{ form.apellido.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.cargo.id_for_label }}">{{ form.cargo.label }}</label>
              {{ form.cargo }} {{ form.cargo.errors }}
            </div>

            <div class="col">
              <label class="form-label" for="{{ form.telefono.id_for_label }}">{{ form.telefono.label }}</label>
              {{ form.telefono }} {{ form.telefono.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
              {{ form.email }} {{ form.email.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.fecha_contratacion.id_for_label }}">{{ form.fecha_contratacion.label }}</label>
              {{ form.fecha_contratacion }} {{ form.fecha_contratacion.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.genero.id_for_label }}">{{ form.genero.label }}</label>
              {{ form.genero }} {{ form.genero.errors }}
            </div>

            <div class="col">
              <label class="form-label" for="{{ form.fecha_nacimiento.id_for_label }}">{{ form.fecha_nacimiento.label }}</label>
              {{ form.fecha_nacimiento }} {{ form.fecha_nacimiento.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.grupo_sanguineo.id_for_label }}">{{ form.grupo_sanguineo.label }}</label>
              {{ form.grupo_sanguineo }} {{ form.grupo_sanguineo.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.direccion.id_for_label }}">{{ form.direccion.label }}</label>
              {{ form.direccion }} {{ form.direccion.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.barrio.id_for_label }}">{{ form.barrio.label }}</label>
              {{ form.barrio }} {{ form.barrio.errors }}
            </div>

            <div class="col">
              <label class="form-label" for="{{ form.ciudad.id_for_label }}">{{ form.ciudad.label }}</label>
              {{ form.ciudad }} {{ form.ciudad.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.departamento.id_for_label }}">{{ form.departamento.label }}</label>
              {{ form.departamento }} {{ form.departamento.errors }}
            </div>
            <div class="col">
              <label class="form-label" for="{{ form.pais.id_for_label }}">{{ form.pais.label }}</label>
              {{ form.pais }} {{ form.pais.errors }}
            </div>

            {% if object %}
            <div class="col d-flex align-items-end">
              <div>
                <label class="form-label d-block m-0">Estado</label>
                {% if object.activo %}
                  <span class="badge bg-success">Activo</span>
                  <a href="{% url 'empleado_inactivate' object.pk %}" class="btn btn-sm btn-outline-warning ms-2" title="Inactivar">
                    <i class="bi bi-x-circle"></i> Inactivar
                  </a>
                {% else %}
                  <span class="badge bg-secondary">Inactivo</span>
                  <a href="{% url 'empleado_inactivate' object.pk %}" class="btn btn-sm btn-outline-success ms-2" title="Reactivar">
                    <i class="bi bi-check-circle"></i> Reactivar
                  </a>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>

          <div class="mt-3">
            <button class="btn btn-custom" type="submit">
              {% if object %}Actualizar{% else %}Guardar{% endif %}
            </button>
            <a href="{% url 'empleado_list' %}" class="btn btn-secondary">Cancelar</a>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<style>
  .card-body { padding: 1rem 1.25rem; }
  .form-label { margin-bottom: .25rem; }
  .form-control, .form-select { padding: .35rem .5rem; height: calc(1.6rem + 2px); }
  #persona-search-wrap { z-index: 1050; }
  #persona-results.show { display:block; }
  #persona-results { max-height: 260px; overflow:auto; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const qInput = document.getElementById('persona-q');
  const btn    = document.getElementById('btn-persona-buscar');
  const menu   = document.getElementById('persona-results');
  const personaId = document.getElementById('id_persona_id');
  const cedula = document.getElementById('id_cedula');
  const nombre = document.getElementById('id_nombre');
  const apellido = document.getElementById('id_apellido');

  function lockBaseFields(lock=true){
    [cedula,nombre,apellido].forEach(el=>{
      if(!el) return;
      el.readOnly = !!lock;
      el.tabIndex = lock ? -1 : 0;
      el.classList.toggle('bg-light', !!lock);
    });
  }

  function applyPersona(p){
    personaId.value = p.id;
    cedula.value = p.cedula;
    nombre.value = p.nombre;
    apellido.value = p.apellido;
    lockBaseFields(true);
  }

  function closeMenu(){ menu.classList.remove('show'); }
  function render(items){
    menu.innerHTML = '';
    (items.length ? items : [{_empty:true}]).forEach(p=>{
      const a = document.createElement('a');
      a.href='#'; a.className='dropdown-item';
      a.textContent = p._empty ? 'Sin resultados.' : `${p.apellido}, ${p.nombre} — CI ${p.cedula}`;
      if (!p._empty){
        a.addEventListener('click', e => { e.preventDefault(); applyPersona(p); closeMenu(); });
      } else {
        a.classList.add('text-muted','small');
      }
      menu.appendChild(a);
    });
    menu.classList.add('show');
  }

  async function doSearch(){
    const q = (qInput?.value || '').trim();
    if(!q){ closeMenu(); return; }
    try{
      const r = await fetch(`{% url 'persona_lookup' %}?q=${encodeURIComponent(q)}`);
      const data = await r.json();
      render(data.results || []);
    }catch{ closeMenu(); }
  }

  btn?.addEventListener('click', doSearch);
  qInput?.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });
  document.addEventListener('click', e => { if(!document.getElementById('persona-search-wrap')?.contains(e.target)) closeMenu(); });

  // Si es edición, bloqueá siempre (los valores vienen del objeto)
  {% if object %} lockBaseFields(true); {% endif %}

  // Si el usuario escribe una cédula exacta y existe Persona, autolock
  cedula?.addEventListener('blur', ()=>{
    const v = (cedula.value||'').trim();
    if(!v) return;
    fetch(`{% url 'persona_lookup' %}?q=${encodeURIComponent(v)}`)
      .then(r=>r.json()).then(data=>{
        const m = (data.results||[]).find(x=>x.cedula===v);
        if(m){ applyPersona(m); }
      }).catch(()=>{});
  });
});
</script>
{% endblock %}
