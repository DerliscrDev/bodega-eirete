{% extends "bodega/base.html" %}
{% block title %}{% if object %}Editar Rol{% else %}Nuevo Rol{% endif %} - Bodega Eirete{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8 col-md-10">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="mb-3">{% if object %}Editar Rol{% else %}Nuevo Rol{% endif %}</h4>

        <form method="post" novalidate>
          {% csrf_token %}
          {{ form.non_field_errors }}

          <div class="mb-3">
            <label class="form-label" for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}</label>
            {{ form.nombre }}
            {{ form.nombre.errors }}
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.descripcion.id_for_label }}">{{ form.descripcion.label }}</label>
            {{ form.descripcion }}
            {{ form.descripcion.errors }}
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.permisos.id_for_label }}">Permisos</label>
            {{ form.permisos }}
            <div class="form-text">Escribí para buscar; Enter para agregar.</div>
            {{ form.permisos.errors }}

            <!-- listado abajo de los seleccionados -->
            <div id="permiso-chips" class="mt-2"></div>
          </div>

          {% if object %}
            <div class="mb-3 d-flex align-items-center gap-2">
              <label class="form-label m-0">Estado</label>
              {% if object.activo %}
                <span class="badge bg-success">Activo</span>
                <a href="{% url 'rol_inactivate' object.pk %}" class="btn btn-sm btn-outline-warning ms-2" title="Inactivar">
                  <i class="bi bi-x-circle"></i> Inactivar
                </a>
              {% else %}
                <span class="badge bg-secondary">Inactivo</span>
                <a href="{% url 'rol_inactivate' object.pk %}" class="btn btn-sm btn-outline-success ms-2" title="Reactivar">
                  <i class="bi bi-check-circle"></i> Reactivar
                </a>
              {% endif %}
            </div>
          {% endif %}

          <div class="mt-4">
            <button class="btn btn-custom" type="submit">
              {% if object %}Actualizar{% else %}Guardar{% endif %}
            </button>
            <a href="{% url 'rol_list' %}" class="btn btn-secondary">Cancelar</a>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- Tom Select -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<!-- Estilo: ocultamos los “items” dentro del input para que solo se vea el buscador -->
<style>
  .ts-wrapper.multi .ts-control .item { display: none; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const selectEl = document.getElementById('id_permisos');
  const chipsBox = document.getElementById('permiso-chips');
  if (!selectEl || !chipsBox) return;

  const ts = new TomSelect(selectEl, {
    plugins: ['remove_button'],
    placeholder: 'Buscar permisos…',
    closeAfterSelect: true,
    allowEmptyOption: true,
    hideSelected: true,
    maxOptions: 2000,
    render: {
      option: (data, esc) => '<div class="py-1 px-2">' + esc(data.text) + '</div>'
      // los items dentro del control los ocultamos por CSS
    },
    onInitialize: function(){ renderSelected(this); },
    onChange: function(){ renderSelected(this); }
  });

  function renderSelected(instance){
    chipsBox.innerHTML = '';
    if (!instance.items.length){
      chipsBox.innerHTML = '<span class="text-muted small">Sin permisos seleccionados.</span>';
      return;
    }
    instance.items.forEach(function(value){
      const opt = instance.options[value];
      const pill = document.createElement('span');
      pill.className = 'badge bg-light text-dark border me-1 mb-1 d-inline-flex align-items-center';
      pill.textContent = opt.text;

      // botón para quitar desde el listado
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-sm btn-link p-0 ms-2';
      btn.setAttribute('aria-label','Quitar');
      btn.innerHTML = '&times;';
      btn.addEventListener('click', function(){ instance.removeItem(value); });

      pill.appendChild(btn);
      chipsBox.appendChild(pill);
    });
  }
});
</script>
{% endblock %}