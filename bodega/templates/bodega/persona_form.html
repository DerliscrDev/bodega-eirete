{% extends 'bodega/base.html' %}
{% load permisos_tags %}

{% block title %}{% if object %}Editar Persona{% else %}Nueva Persona{% endif %} - Bodega Eirete{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-8 offset-md-2">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">
          {% if object %}Editar Persona{% else %}Nueva Persona{% endif %}
        </h2>

        {% if request.user|tiene_permiso:"crear_persona" or request.user|tiene_permiso:"editar_persona" %}
          <form method="post" novalidate>
            {% csrf_token %}
            {{ form.non_field_errors }}

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label" for="{{ form.cedula.id_for_label }}">Cédula</label>
                {{ form.cedula }}
                <div class="text-danger small">{{ form.cedula.errors }}</div>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label" for="{{ form.nombre.id_for_label }}">Nombre</label>
                {{ form.nombre }}
                <div class="text-danger small">{{ form.nombre.errors }}</div>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label" for="{{ form.apellido.id_for_label }}">Apellido</label>
                {{ form.apellido }}
                <div class="text-danger small">{{ form.apellido.errors }}</div>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-custom rounded-2">
                {% if object %}<i class="bi bi-save me-1"></i> Actualizar{% else %}<i class="bi bi-check2-circle me-1"></i> Guardar{% endif %}
              </button>
              <a href="{% url 'persona_list' %}" class="btn btn-secondary rounded-2">Cancelar</a>
            </div>
          </form>
        {% else %}
          <div class="alert alert-warning mb-0">
            No tienes permiso para crear o editar personas.
          </div>
        {% endif %}
      </div>
    </div>

    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      El estado <strong>Activo</strong> de la persona está habilitado por defecto y no es editable desde este formulario.
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Marca los campos requeridos con asterisco rojo (según atributo required)
  (function () {
    const form = document.querySelector('form');
    if (!form) return;
    form.querySelectorAll('input, select, textarea').forEach(ctrl => {
      if (ctrl.hasAttribute('required')) {
        const label = form.querySelector('label[for="'+ ctrl.id +'"]');
        if (label && !label.querySelector('.text-danger')) {
          label.insertAdjacentHTML('beforeend', ' <span class="text-danger">*</span>');
        }
      }
    });
  })();
</script>
{% endblock %}
